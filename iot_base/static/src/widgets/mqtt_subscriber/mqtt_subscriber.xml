<?xml version="1.0" encoding="UTF-8" ?>
<templates xml:space="preserve">
    <t t-name="iot_base.MQTTSubscriber">
    <div t-attf-class="mqtt-subscriber card shadow-sm {{props.className}}">
      <!-- Header -->
      <div
        class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fa fa-satellite-dish me-2" />
          <t t-esc="props.title" />
        </h5>
        <span t-att-class="'badge ' + statusBadgeClass">
          <t t-esc="connectionStatus" />
        </span>
      </div>

      <!-- Body -->
      <div class="card-body">
        <!-- Connection Settings -->
        <div t-if="!mqttService.state.connected" class="mb-3">
          <Input
            label="'Broker URL'"
            value="state.brokerUrl"
            placeholder="'ws://localhost:8883'"
            onChange.bind="onBrokerUrlChange"
          />
          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <Input
                label="'Username (Optional)'"
                value="state.username"
                placeholder="'mqtt_user'"
                onChange.bind="onUsernameChange"
              />
            </div>
            <div class="col-md-6">
              <Input
                label="'Password (Optional)'"
                type="'password'"
                value="state.password"
                placeholder="'********'"
                onChange.bind="onPasswordChange"
              />
            </div>
          </div>
        </div>

        <!-- Topic Subscription -->
        <div class="row g-2 mb-3">
          <div class="col">
            <Input
              label="'MQTT Topic'"
              value="state.topic"
              placeholder="'sensors/temperature'"
              onChange.bind="onTopicChange"
              onEnter.bind="onSubscribe"
              disabled="state.isSubscribing"
            />
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-2 mb-3">
          <Button
            t-if="!isSubscribed"
            label="'Subscribe'"
            variant="'primary'"
            icon="'fa-play'"
            onClick.bind="onSubscribe"
            loading="state.isSubscribing"
            disabled="!state.topic"
          />
          <Button
            t-if="isSubscribed"
            label="'Unsubscribe'"
            variant="'danger'"
            icon="'fa-stop'"
            onClick.bind="onUnsubscribe"
          />
          <Button
            t-if="state.messages.length > 0"
            label="'Clear'"
            variant="'secondary'"
            icon="'fa-trash'"
            onClick.bind="onClearMessages"
          />
        </div>

        <!-- Subscription Info -->
        <div
          t-if="isSubscribed"
          class="alert alert-info d-flex align-items-center mb-3"
        >
          <i class="fa fa-info-circle me-2" />
          <span>
                        Subscribed to: <strong t-esc="state.subscribedTopic" />
                    </span>
        </div>

        <!-- Error Message -->
        <div
          t-if="state.error"
          class="alert alert-danger d-flex align-items-center mb-3"
        >
          <i class="fa fa-exclamation-triangle me-2" />
          <span t-esc="state.error" />
        </div>

        <!-- MQTT Connection Error -->
        <div
          t-if="mqttService.state.error"
          class="alert alert-danger d-flex align-items-center mb-3"
        >
          <i class="fa fa-exclamation-triangle me-2" />
          <span>Connection Error: <t t-esc="mqttService.state.error" /></span>
        </div>

        <!-- Messages Display -->
        <div class="messages-container">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">
                            <i class="fa fa-envelope me-1" />
                            Messages
                            <span
              t-if="state.messages.length > 0"
              class="badge bg-primary ms-2"
            >
              <t t-esc="state.messages.length" />
            </span>
                        </h6>
          </div>

          <div t-if="state.messages.length === 0" class="text-center text-muted py-5">
            <i class="fa fa-inbox fa-3x mb-3 d-block" />
            <p>No messages received yet</p>
            <small
              t-if="!isSubscribed"
            >Subscribe to a topic to start receiving messages</small>
          </div>

          <div t-if="state.messages.length > 0" class="messages-list">
            <div
              t-foreach="state.messages"
              t-as="msg"
              t-key="msg.id"
              class="message-item card mb-2"
            >
              <div class="card-body p-3">
                <div class="d-flex justify-content-between align-items-start mb-2">
                  <span class="badge bg-secondary">
                    <t t-esc="msg.topic" />
                  </span>
                  <small class="text-muted">
                    <i class="fa fa-clock me-1" />
                    <t t-esc="msg.timestamp" />
                  </small>
                </div>
                <pre class="message-content mb-0">
                  <t t-esc="formatMessage(msg.message)" />
                </pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </t>
</templates>
